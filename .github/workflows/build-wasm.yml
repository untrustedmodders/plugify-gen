name: Build WebAssembly

on:
  push:
    branches:
      - main
    paths:
      - 'cmd/wasm/**'
      - 'pkg/**'
      - 'build-wasm.sh'
      - '.github/workflows/build-wasm.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.23'

jobs:
  build-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Get version from manifest
        id: version
        run: |
          VERSION=$(cat .github/release-please-manifest.json | grep -o '"."[[:space:]]*:[[:space:]]*"[^"]*"' | grep -o '"[0-9][^"]*"' | tr -d '"')
          if [ -z "$VERSION" ]; then
            VERSION="dev"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building WebAssembly version: $VERSION"

      - name: Build WebAssembly
        run: |
          mkdir -p dist
          GOOS=js GOARCH=wasm go build -ldflags="-X main.version=${{ steps.version.outputs.version }}" -o dist/plugify-gen.wasm ./cmd/wasm/main.go
          cp "$(go env GOROOT)/lib/wasm/wasm_exec.js" dist/wasm_exec.js || cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" dist/wasm_exec.js
          # Generate version.js for cache busting
          echo "// Auto-generated by build-wasm.yml - DO NOT EDIT" > dist/version.js
          echo "window.PLUGIFY_GEN_VERSION = '${{ steps.version.outputs.version }}';" >> dist/version.js

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugify-gen-wasm-${{ steps.version.outputs.version }}
          path: dist/
          retention-days: 90

      - name: Display build info
        run: |
          echo "WebAssembly build complete!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo ""
          echo "Generated files:"
          ls -lh dist/
          echo ""
          echo "To deploy: Copy dist/* to your web server's directory"
          echo "Note: version.js enables automatic cache busting for the WASM module"